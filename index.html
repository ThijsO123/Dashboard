<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>WORK.LINKS + TASKLIST</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg-main: #050608;
      --bg-elevated: #0b0f13;
      --bg-input: #11151b;
      --border-soft: #181c21;
      --accent: #5cff8f;
      --accent-soft: rgba(92, 255, 143, 0.2);
      --text-main: #e9fff0;
      --text-muted: #798189;
      --danger: #ff4f6b;
      --radius: 4px;
      --transition-fast: 0.15s ease-out;
    }

    * { box-sizing: border-box; }

    html { scroll-behavior: smooth; }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #0c1218 0, #050608 55%);
      color: var(--text-main);
      font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
      position: relative;
      overflow-x: hidden;
    }

    /* Noise overlay */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: 0.15;
      mix-blend-mode: soft-light;
      background-image:
        repeating-linear-gradient(
          0deg,
          rgba(255,255,255,0.11) 0,
          rgba(255,255,255,0.11) 1px,
          transparent 1px,
          transparent 2px
        ),
        repeating-linear-gradient(
          90deg,
          rgba(0,0,0,0.18) 0,
          rgba(0,0,0,0.18) 1px,
          transparent 1px,
          transparent 2px
        );
      z-index: -1;
    }

    .app {
      max-width: 1100px;
      margin: 32px auto 40px;
      padding: 0 24px 24px;
    }

    .app-frame-line {
      border-top: 1px solid var(--border-soft);
      margin-bottom: 32px;
    }

    header {
      text-align: center;
      margin-bottom: 32px;
    }

    .system-label {
      font-size: 11px;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .week-display {
      font-size: clamp(40px, 7vw, 64px);
      font-weight: 700;
      letter-spacing: 0.06em;
      color: var(--accent);
      text-shadow:
        0 0 8px rgba(92, 255, 143, 0.8),
        0 0 30px rgba(92, 255, 143, 0.5);
      margin: 0 0 4px;
    }

    .week-display .small-dot {
      font-size: 0.7em;
      margin: 0 0.1em;
    }

    .date-display {
      font-size: 14px;
      color: var(--text-muted);
    }

    /* Buttons & inputs */

    button {
      border-radius: var(--radius);
      border: 1px solid var(--border-soft);
      background: var(--bg-elevated);
      color: var(--text-main);
      font-size: 13px;
      padding: 9px 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition:
        background var(--transition-fast),
        border var(--transition-fast),
        transform var(--transition-fast),
        box-shadow var(--transition-fast),
        color var(--transition-fast);
    }

    button:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #011208;
      font-weight: 600;
      box-shadow: 0 0 14px rgba(92, 255, 143, 0.45);
    }

    .btn-primary:hover {
      background: #70ff9d;
      border-color: #70ff9d;
      transform: translateY(-1px);
      box-shadow: 0 0 20px rgba(92, 255, 143, 0.7);
    }

    .btn-ghost {
      background: #0c1117;
    }

    .btn-ghost:hover {
      background: #101620;
      border-color: #242c35;
    }

    .btn-icon { font-size: 14px; opacity: 0.85; }

    .input-field {
      width: 100%;
      padding: 9px 10px;
      border-radius: var(--radius);
      border: 1px solid var(--border-soft);
      background: var(--bg-input);
      color: var(--text-main);
      font-size: 13px;
      outline: none;
      transition:
        border var(--transition-fast),
        box-shadow var(--transition-fast),
        background var(--transition-fast);
    }

    .input-field::placeholder { color: #5b626b; }

    .input-field:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
      background: #0f151d;
    }

    /* Search bar */

    .search-bar {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
    }

    .search-input-wrapper {
      flex: 1;
      position: relative;
    }

    .search-input-wrapper .icon-search {
      position: absolute;
      left: 13px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 13px;
      color: var(--text-muted);
      pointer-events: none;
    }

    .search-input {
      width: 100%;
      padding: 10px 12px 10px 32px;
      border-radius: var(--radius);
      border: 1px solid var(--border-soft);
      background: var(--bg-input);
      color: var(--text-main);
      font-size: 13px;
      outline: none;
      transition: border var(--transition-fast), box-shadow var(--transition-fast),
        background var(--transition-fast);
    }

    .search-input::placeholder { color: #5b626b; }

    .search-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
      background: #0f151d;
    }

    .search-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    /* Quick filters */

    .quick-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .chip {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      border: 1px solid var(--border-soft);
      background: rgba(7, 11, 16, 0.9);
      color: var(--text-muted);
      cursor: pointer;
    }

    .chip.active {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(92, 255, 143, 0.08);
    }

    .icon-button {
      padding: 4px;
      border-radius: 3px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-muted);
      font-size: 13px;
      line-height: 1;
      min-width: 0;
      transition:
        background var(--transition-fast),
        border var(--transition-fast),
        color var(--transition-fast),
        transform var(--transition-fast);
    }

    .icon-button:hover {
      color: var(--accent);
      border-color: var(--accent-soft);
      background: rgba(92, 255, 143, 0.06);
      transform: translateY(-1px);
    }

    .icon-button.delete {
      color: #ff7f91;
    }

    .icon-button.delete:hover {
      border-color: var(--danger);
      background: #23060b;
      color: #ffe6ea;
    }

    .drag-handle {
      font-size: 15px;
      cursor: grab;
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transition-fast);
    }

    /* New link form */

    .new-link-card {
      border-radius: var(--radius);
      border: 1px solid var(--border-soft);
      background: var(--bg-elevated);
      padding: 16px;
      margin-bottom: 24px;
    }

    .new-link-label {
      font-size: 11px;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 10px;
    }

    .link-form {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.3fr) minmax(0, 1.1fr) auto;
      gap: 8px;
    }

    .btn-add {
      white-space: nowrap;
      padding-inline: 16px;
    }

    /* Links per categorie */

    .links-panel {
      min-height: 120px;
      padding: 4px 0 8px;
    }

    .empty-state {
      text-align: center;
      margin-top: 30px;
      color: var(--text-muted);
      font-size: 12px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
    }

    .empty-state small {
      display: block;
      margin-top: 6px;
      letter-spacing: normal;
      text-transform: none;
      font-size: 12px;
      color: #8a939f;
    }

    .category-block {
      margin-bottom: 28px;
    }

    .category-title {
      font-size: 12px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin: 18px 0 8px;
      position: relative;
    }

    .category-title::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: -6px;
      width: 80px;
      height: 1px;
      background: linear-gradient(to right, var(--accent), transparent);
      opacity: 0.4;
    }

    @keyframes categoryPulse {
      0%   { box-shadow: 0 0 0 rgba(92, 255, 143, 0);   transform: translateY(0); }
      40%  { box-shadow: 0 0 24px rgba(92, 255, 143, .4); transform: translateY(-1px); }
      100% { box-shadow: 0 0 0 rgba(92, 255, 143, 0);   transform: translateY(0); }
    }

    .category-block.category-pulse { animation: categoryPulse 0.7s ease-out; }

    .links-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    @keyframes cardIn {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: translateY(0);   }
    }

    .link-card {
      border-radius: var(--radius);
      border: 1px solid var(--border-soft);
      border-left: 2px solid rgba(92, 255, 143, 0.12);
      background: rgba(7, 11, 16, 0.92);
      padding: 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      transition:
        border-color var(--transition-fast),
        box-shadow var(--transition-fast),
        background var(--transition-fast),
        transform var(--transition-fast);
      animation: cardIn 0.18s ease-out;
    }

    .link-card:hover {
      border-color: var(--accent-soft);
      border-left-color: var(--accent);
      background: #071015;
      box-shadow: 0 0 18px rgba(92, 255, 143, 0.18);
      transform: translateY(-1px);
    }

    .link-card.drag-over {
      border-style: dashed;
      border-color: var(--accent);
      background: #050b0d;
    }

    .link-left {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      min-width: 0;
    }

    .link-main { min-width: 0; }

    .link-title {
      font-weight: 600;
      margin-bottom: 3px;
      color: var(--accent);
      letter-spacing: 0.02em;
    }

    .link-url-row {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .link-url {
      font-size: 11px;
      color: #9fd4ff;
      text-decoration: none;
      word-break: break-all;
      opacity: 0.85;
    }

    .link-url:hover { text-decoration: underline; }

    .link-actions {
      display: flex;
      gap: 6px;
      align-items: center;
      opacity: 0;
      pointer-events: none;
      transform: translateY(1px);
      transition: opacity var(--transition-fast), transform var(--transition-fast);
    }

    .link-card:hover .link-actions,
    .link-card:hover .drag-handle {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    /* Tasklist */

    .tasklist {
      margin-top: 32px;
      padding: 16px;
      border-radius: var(--radius);
      border: 1px solid var(--border-soft);
      background: #05080f;
    }

    .tasklist-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .tasklist-label {
      font-size: 11px;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: var(--accent);
    }

    .tasklist-meta {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .tasklist-meta span:first-child {
      color: var(--accent);
      font-weight: 500;
    }

    .task-form {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.2fr) minmax(0, 1.2fr) minmax(0, 1.6fr) auto;
      gap: 8px;
      margin-bottom: 14px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(24, 28, 33, 0.8);
    }

    .task-add-btn { white-space: nowrap; }

    .task-columns {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 14px;
    }

    .task-column-title {
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .task-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 40px;
    }

    .task-empty {
      font-size: 11px;
      color: var(--text-muted);
      opacity: 0.7;
    }

    .task-card {
      border-radius: var(--radius);
      border: 1px solid var(--border-soft);
      background: rgba(6, 10, 15, 0.95);
      padding: 8px 10px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: flex-start;
      transition:
        border var(--transition-fast),
        background var(--transition-fast),
        transform var(--transition-fast),
        box-shadow var(--transition-fast);
    }

    .task-card:hover {
      border-color: var(--accent-soft);
      background: #060c13;
      box-shadow: 0 0 12px rgba(92, 255, 143, 0.18);
      transform: translateY(-1px);
    }

    .task-main {
      display: flex;
      gap: 8px;
      align-items: flex-start;
      min-width: 0;
    }

    .task-check { margin-top: 2px; }

    .task-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 2px;
      color: var(--text-main);
      word-wrap: break-word;
    }

    .task-title.done {
      text-decoration: line-through;
      color: var(--text-muted);
      opacity: 0.7;
    }

    .task-meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .task-pill {
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid #222b33;
      background: rgba(0, 0, 0, 0.25);
      white-space: nowrap;
    }

    .task-pill--due {
      border-color: #3077ff;
      color: #9fd4ff;
    }

    .task-pill--due-overdue {
      border-color: var(--danger);
      color: #ffb3c1;
      background: #23060b;
    }

    .task-pill--prio-high {
      border-color: var(--danger);
      color: #ffb3c1;
    }

    .task-pill--prio-normal {
      border-color: #ffaa33;
      color: #ffdca3;
    }

    .task-pill--prio-low {
      border-color: #4fa3ff;
      color: #c4e0ff;
    }

    .task-pill--link {
      border-color: #4fa3ff;
      color: #c4e0ff;
      cursor: pointer;
    }

    .task-actions {
      display: flex;
      gap: 4px;
    }

    /* Terminal */

    .terminal {
      margin-top: 24px;
      border-radius: var(--radius);
      border: 1px solid var(--border-soft);
      background: #05090f;
      padding: 10px 12px 12px;
      font-size: 12px;
    }

    .terminal-header {
      font-size: 11px;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .terminal-output {
      max-height: 180px;
      overflow-y: auto;
      padding: 6px 4px 6px 0;
      font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
    }

    @keyframes termIn {
      from { opacity: 0; transform: translateY(1px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .terminal-line {
      white-space: pre-wrap;
      margin-bottom: 2px;
      animation: termIn 0.12s ease-out;
    }

    .terminal-line .cmd { color: var(--accent); }
    .terminal-line .error { color: var(--danger); }

    .terminal-input-line {
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      border-top: 1px solid var(--border-soft);
      padding-top: 6px;
    }

    .prompt-label {
      color: var(--accent);
      font-size: 12px;
    }

    .terminal-input {
      flex: 1;
      border: none;
      background: transparent;
      color: var(--text-main);
      font-family: inherit;
      font-size: 12px;
      outline: none;
      padding: 4px 2px;
    }

    .terminal-input::placeholder { color: #5b626b; }

    /* Floating button */

    .fab {
      position: fixed;
      right: 18px;
      bottom: 20px;
      border-radius: 999px;
      padding: 12px 16px;
      background: var(--accent);
      border-color: var(--accent);
      color: #011208;
      font-weight: 700;
      font-size: 16px;
      box-shadow: 0 0 18px rgba(92, 255, 143, 0.6);
      z-index: 30;
    }

    .fab span {
      font-size: 18px;
      margin-right: 4px;
    }

    .fab:hover {
      background: #70ff9d;
      border-color: #70ff9d;
      transform: translateY(-1px);
      box-shadow: 0 0 24px rgba(92, 255, 143, 0.85);
    }

    /* Footer */

    footer {
      border-top: 1px solid var(--border-soft);
      margin-top: 28px;
      padding-top: 10px;
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.16em;
      text-transform: uppercase;
      text-align: center;
    }

    footer .count { color: var(--accent); }

    /* WORKSPACE LAYOUT: links + tasklist */

    .workspace {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Responsive */

    @media (max-width: 800px) {
      .app {
        margin: 16px auto 28px;
        padding: 0 16px 24px;
      }

      header { margin-bottom: 20px; }

      .week-display {
        font-size: 32px;
        letter-spacing: 0.04em;
      }

      .date-display { font-size: 12px; }

      .link-form { grid-template-columns: 1fr; }
      .btn-add { justify-content: center; }

      .search-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .search-actions { justify-content: flex-end; }

      .link-card {
        flex-direction: column;
        align-items: flex-start;
      }

      .link-actions {
        opacity: 1;
        pointer-events: auto;
        transform: translateY(0);
      }

      .drag-handle {
        opacity: 0.6;
        pointer-events: none;
      }

      .terminal { margin-top: 18px; }

      .terminal-output { max-height: 140px; }

      .task-form { grid-template-columns: 1fr; }
      .task-columns { grid-template-columns: 1fr; }
    }

    @media (min-width: 801px) {
      .fab { display: none; }
    }

    /* Desktop workspace layout: naast elkaar + 2-regelige task-form */
    @media (min-width: 1024px) {
      .workspace {
        display: grid;
        grid-template-columns: minmax(0, 2fr) minmax(0, 1.1fr);
        gap: 24px;
        align-items: flex-start;
      }

      .tasklist {
        margin-top: 0;
      }

      .links-panel {
        min-height: 0;
      }

      .task-form {
        grid-template-columns: minmax(0, 2.5fr) minmax(0, 1.4fr) minmax(0, 1.2fr) minmax(0, 1.8fr) auto;
        grid-template-areas:
          "title title title title button"
          "due   prio  link  link  button";
      }

      #taskTitleInput    { grid-area: title; }
      #taskDueInput      { grid-area: due; }
      #taskPriorityInput { grid-area: prio; }
      #taskLinkInput     { grid-area: link; }
      .task-add-btn      { grid-area: button; align-self: stretch; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="app-frame-line"></div>

    <header>
      <div class="system-label">SYSTEM.TIME</div>
      <h1 class="week-display" id="weekDisplay">
        Week 00<span class="small-dot">.</span>0
      </h1>
      <div class="date-display" id="dateDisplay">
        datum wordt geladen‚Ä¶
      </div>
    </header>

    <main>
      <!-- Search -->
      <section class="search-bar">
        <div class="search-input-wrapper">
          <span class="icon-search">üîç</span>
          <input
            type="text"
            id="searchInput"
            class="search-input"
            placeholder="Zoek in links..."
          />
        </div>
        <div class="search-actions">
          <button id="exportBtn" class="btn-ghost" type="button">
            <span class="btn-icon">‚≠≥</span> Exporteren
          </button>
          <button id="importBtn" class="btn-ghost" type="button">
            <span class="btn-icon">‚≠±</span> Importeren
          </button>
          <input
            type="file"
            id="importFile"
            accept="application/json"
            hidden
          />
        </div>
      </section>

      <!-- Quick filters -->
      <section class="quick-filters">
        <button type="button" class="chip active" data-filter="all">Alle</button>
        <button type="button" class="chip" data-filter="inbox">Inbox</button>
        <button type="button" class="chip" data-filter="today">Vandaag</button>
        <button type="button" class="chip" data-filter="week">Deze week</button>
      </section>

      <!-- New link -->
      <section class="new-link-card" id="newLinkSection">
        <div class="new-link-label">+ Nieuwe link toevoegen</div>
        <form id="linkForm" class="link-form" autocomplete="off">
          <input
            id="titleInput"
            class="input-field"
            type="text"
            placeholder="Titel"
            required
          />
          <input
            id="urlInput"
            class="input-field"
            type="url"
            placeholder="URL"
            required
          />
          <div>
            <input
              id="categoryInput"
              class="input-field"
              type="text"
              placeholder="Categorie (optioneel)"
              list="categorySuggestions"
            />
            <datalist id="categorySuggestions"></datalist>
          </div>
          <button type="submit" class="btn-primary btn-add">
            <span>+</span> Toevoegen
          </button>
        </form>
      </section>

      <!-- WORKSPACE: links + tasklist -->
      <div class="workspace">
        <!-- Links per categorie -->
        <section class="links-panel">
          <div id="emptyState" class="empty-state">
            GEEN LINKS GEVONDEN
            <small>Voeg je eerste link toe om te beginnen</small>
          </div>

          <div id="categoriesRoot" style="display:none;"></div>
        </section>

        <!-- TASKLIST.APP -->
        <section class="tasklist" id="tasklistSection">
          <div class="tasklist-header">
            <div class="tasklist-label">TASKLIST.APP</div>
            <div class="tasklist-meta">
              <span id="taskCountOpen">0 open</span>
              <span>‚Ä¢</span>
              <span id="taskCountDone">0 gedaan</span>
            </div>
          </div>

          <form id="taskForm" class="task-form" autocomplete="off">
            <input
              id="taskTitleInput"
              class="input-field"
              type="text"
              placeholder="Taak..."
              required
            />
            <input
              id="taskDueInput"
              class="input-field"
              type="date"
            />
            <select id="taskPriorityInput" class="input-field">
              <option value="">Prio</option>
              <option value="high">Hoog</option>
              <option value="normal">Normaal</option>
              <option value="low">Laag</option>
            </select>
            <input
              id="taskLinkInput"
              class="input-field"
              type="url"
              placeholder="URL (optioneel)"
            />
            <button type="submit" class="btn-primary task-add-btn">
              + Taak
            </button>
          </form>

          <div class="task-columns">
            <div class="task-column">
              <div class="task-column-title">Open</div>
              <div id="taskListOpen" class="task-list"></div>
            </div>
            <div class="task-column">
              <div class="task-column-title">Gedaan</div>
              <div id="taskListDone" class="task-list"></div>
            </div>
          </div>
        </section>
      </div>

      <!-- Terminal -->
      <section class="terminal" id="terminalSection">
        <div class="terminal-header">WORK.TERMINAL</div>
        <div class="terminal-output" id="terminalOutput">
          <div class="terminal-line">
            type <span class="cmd">help</span> voor link-commando's,
            <span class="cmd">t-help</span> voor taken.
          </div>
        </div>
        <div class="terminal-input-line">
          <span class="prompt-label">&gt;</span>
          <input
            id="terminalInput"
            class="terminal-input"
            type="text"
            autocomplete="off"
            placeholder="command..."
          />
        </div>
      </section>
    </main>

    <footer>
      WORK.LINKS v1.2 //
      <span class="count" id="linksCount">0</span> LINKS //
      <span class="count" id="categoriesCount">0</span> CATEGORIE√ãN //
      LAATST: <span id="lastModifiedDisplay">-</span>
    </footer>
  </div>

  <!-- Floating add button (mobiel) -->
  <button type="button" class="fab" id="fabAdd">
    <span>Ôºã</span>Link
  </button>

  <script>
    "use strict";

    // --- Time / week display ---------------------------------------------
    function computeIsoWeek(date) {
      const tmp = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = tmp.getUTCDay() || 7; // 1..7 (ma=1)
      tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(), 0, 1));
      const weekNo = Math.ceil(((tmp - yearStart) / 86400000 + 1) / 7);
      return weekNo;
    }

    function updateTimeHeader() {
      const now = new Date();
      const week = computeIsoWeek(now);
      const dayIndex = ((now.getDay() + 6) % 7) + 1; // maandag = 1
      const weekDisplay = document.getElementById("weekDisplay");
      weekDisplay.innerHTML =
        "Week " + week + '<span class="small-dot">.</span>' + dayIndex;

      const dateOptions = {
        weekday: "long",
        day: "numeric",
        month: "long",
        year: "numeric",
      };
      const dateStr = now
        .toLocaleDateString("nl-NL", dateOptions)
        .replace(/^./, (c) => c.toLowerCase());
      document.getElementById("dateDisplay").textContent = dateStr;
    }

    updateTimeHeader();

    // --- Helpers ----------------------------------------------------------
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function isSameDay(d1, d2) {
      return d1.getFullYear() === d2.getFullYear() &&
             d1.getMonth() === d2.getMonth() &&
             d1.getDate() === d2.getDate();
    }

    function isWithinLastDays(d, days) {
      const now = new Date();
      const diff = now - d;
      return diff >= 0 && diff <= days * 86400000;
    }

    function normalizeUrl(url) {
      if (!url) return "";
      if (/^https?:\/\//i.test(url)) return url;
      return "https://" + url;
    }

    function formatShortDate(d) {
      return d.toLocaleDateString("nl-NL", { day: "2-digit", month: "2-digit" });
    }

    // --- LINKS DATA -------------------------------------------------------
    const LINK_STORAGE_KEY = "workLinksDataV1";
    const LAST_MODIFIED_KEY = "workLinksLastModified";
    const PINNED_CATEGORIES = ["Inbox", "Today"];

    let links = [];
    let lastModified = null;
    let currentCategoriesCount = 0;
    let categoryPulseName = null;

    function loadLinksFromStorage() {
      try {
        const raw = localStorage.getItem(LINK_STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) {
          links = parsed;
        }
      } catch (err) {
        console.error("Kon links niet laden:", err);
      }
    }

    function saveLinksToStorage() {
      try {
        localStorage.setItem(LINK_STORAGE_KEY, JSON.stringify(links));
      } catch (err) {
        console.error("Kon links niet opslaan:", err);
      }
    }

    function loadLastModified() {
      try {
        const raw = localStorage.getItem(LAST_MODIFIED_KEY);
        if (raw) {
          const d = new Date(raw);
          if (!isNaN(d)) lastModified = d;
        }
      } catch {
        // ignore
      }
    }

    function touchLastModified() {
      lastModified = new Date();
      try {
        localStorage.setItem(LAST_MODIFIED_KEY, lastModified.toISOString());
      } catch {
        // ignore
      }
      updateFooterMeta();
    }

    function getAllCategories() {
      const set = new Set();
      links.forEach((l) => {
        const c = (l.category || "Algemeen").trim() || "Algemeen";
        set.add(c);
      });
      return Array.from(set).sort((a, b) =>
        a.localeCompare(b, "nl", { sensitivity: "base" })
      );
    }

    function updateCategorySuggestions() {
      const datalist = document.getElementById("categorySuggestions");
      if (!datalist) return;
      datalist.innerHTML = "";
      getAllCategories().forEach((cat) => {
        const opt = document.createElement("option");
        opt.value = cat;
        datalist.appendChild(opt);
      });
    }

    function updateFooterMeta() {
      const categoriesCountEl = document.getElementById("categoriesCount");
      const lastModifiedDisplay = document.getElementById("lastModifiedDisplay");
      if (categoriesCountEl) {
        categoriesCountEl.textContent = String(currentCategoriesCount);
      }
      if (lastModifiedDisplay) {
        if (lastModified instanceof Date && !isNaN(lastModified)) {
          const opts = {
            day: "2-digit",
            month: "2-digit",
            year: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
          };
          lastModifiedDisplay.textContent = lastModified.toLocaleString("nl-NL", opts);
        } else {
          lastModifiedDisplay.textContent = "-";
        }
      }
    }

    // --- LINKS Rendering --------------------------------------------------
    const emptyStateEl = document.getElementById("emptyState");
    const categoriesRoot = document.getElementById("categoriesRoot");
    const linksCount = document.getElementById("linksCount");
    const searchInput = document.getElementById("searchInput");

    let currentQuickFilter = "all"; // all | inbox | today | week | category
    let currentCategoryFilterName = "";

    function renderLinks() {
      const query = searchInput.value.trim().toLowerCase();

      const allCatSet = new Set();
      links.forEach((l) => {
        const name = (l.category || "Algemeen").trim() || "Algemeen";
        allCatSet.add(name);
      });
      currentCategoriesCount = allCatSet.size;

      const filtered = links.filter((link) => {
        const catRaw = (link.category || "").trim();
        const cat = catRaw || "Algemeen";

        let matchesSearch =
          !query ||
          (link.title || "").toLowerCase().includes(query) ||
          (link.url || "").toLowerCase().includes(query) ||
          (link.category || "").toLowerCase().includes(query);

        let matchesQuick = true;
        const created = link.createdAt ? new Date(link.createdAt) : null;

        switch (currentQuickFilter) {
          case "inbox":
            matchesQuick = cat === "Inbox";
            break;
          case "today":
            matchesQuick = created && isSameDay(created, new Date());
            break;
          case "week":
            matchesQuick = created && isWithinLastDays(created, 7);
            break;
          case "category":
            matchesQuick =
              catRaw.toLowerCase() === currentCategoryFilterName.toLowerCase();
            break;
          default:
            matchesQuick = true;
        }

        return matchesSearch && matchesQuick;
      });

      categoriesRoot.innerHTML = "";

      if (filtered.length === 0) {
        emptyStateEl.style.display = "block";
        categoriesRoot.style.display = "none";
      } else {
        emptyStateEl.style.display = "none";
        categoriesRoot.style.display = "block";

        const groupMap = new Map();
        filtered.forEach((link) => {
          const key = (link.category && link.category.trim()) || "Algemeen";
          if (!groupMap.has(key)) groupMap.set(key, []);
          groupMap.get(key).push(link);
        });

        const categoryNames = Array.from(groupMap.keys()).sort((a, b) => {
          const aPinned = PINNED_CATEGORIES.includes(a);
          const bPinned = PINNED_CATEGORIES.includes(b);
          if (aPinned && !bPinned) return -1;
          if (bPinned && !aPinned) return 1;
          return a.localeCompare(b, "nl", { sensitivity: "base" });
        });

        categoryNames.forEach((catName) => {
          const block = document.createElement("section");
          block.className = "category-block";
          if (categoryPulseName && catName === categoryPulseName) {
            block.classList.add("category-pulse");
          }

          const h = document.createElement("h2");
          h.className = "category-title";
          h.textContent = catName;
          block.appendChild(h);

          const container = document.createElement("div");
          container.className = "links-container";

          const items = groupMap.get(catName);
          items.forEach((link) => {
            container.appendChild(renderLinkCard(link));
          });

          block.appendChild(container);
          categoriesRoot.appendChild(block);
        });
      }

      categoryPulseName = null;

      linksCount.textContent = String(links.length);
      updateCategorySuggestions();
      updateFooterMeta();
    }

    let dragSourceId = null;

    function clearDragClasses() {
      document
        .querySelectorAll(".link-card.dragging, .link-card.drag-over")
        .forEach((el) => {
          el.classList.remove("dragging", "drag-over");
        });
    }

    function renderLinkCard(link) {
      const card = document.createElement("div");
      card.className = "link-card";
      card.setAttribute("draggable", "true");
      card.dataset.id = link.id;

      const left = document.createElement("div");
      left.className = "link-left";

      const dragBtn = document.createElement("button");
      dragBtn.type = "button";
      dragBtn.className = "icon-button drag-handle";
      dragBtn.title = "Verslepen";
      dragBtn.textContent = "‚ãÆ‚ãÆ";

      const main = document.createElement("div");
      main.className = "link-main";

      const titleEl = document.createElement("div");
      titleEl.className = "link-title";
      titleEl.textContent = link.title || "Zonder titel";

      const urlRow = document.createElement("div");
      urlRow.className = "link-url-row";

      const urlEl = document.createElement("a");
      urlEl.className = "link-url";
      urlEl.href = link.url;
      urlEl.target = "_blank";
      urlEl.rel = "noopener noreferrer";
      urlEl.textContent = link.url;

      const extIcon = document.createElement("span");
      extIcon.style.fontSize = "11px";
      extIcon.textContent = "‚Üó";

      urlRow.appendChild(urlEl);
      urlRow.appendChild(extIcon);

      main.appendChild(titleEl);
      main.appendChild(urlRow);

      left.appendChild(dragBtn);
      left.appendChild(main);

      const actions = document.createElement("div");
      actions.className = "link-actions";

      const upBtn = document.createElement("button");
      upBtn.type = "button";
      upBtn.className = "icon-button";
      upBtn.title = "Omhoog binnen categorie";
      upBtn.textContent = "‚Üë";
      upBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        handleMoveUp(link.id);
      });

      const downBtn = document.createElement("button");
      downBtn.type = "button";
      downBtn.className = "icon-button";
      downBtn.title = "Omlaag binnen categorie";
      downBtn.textContent = "‚Üì";
      downBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        handleMoveDown(link.id);
      });

      const editBtn = document.createElement("button");
      editBtn.type = "button";
      editBtn.className = "icon-button";
      editBtn.title = "Bewerken";
      editBtn.textContent = "‚úè";
      editBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        handleEdit(link);
      });

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "icon-button delete";
      delBtn.title = "Verwijderen";
      delBtn.textContent = "üóë";
      delBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        handleDelete(link.id);
      });

      actions.appendChild(upBtn);
      actions.appendChild(downBtn);
      actions.appendChild(editBtn);
      actions.appendChild(delBtn);

      card.appendChild(left);
      card.appendChild(actions);

      card.addEventListener("dragstart", (e) => {
        dragSourceId = link.id;
        card.classList.add("dragging");
        if (e.dataTransfer) e.dataTransfer.effectAllowed = "move";
      });

      card.addEventListener("dragend", () => {
        clearDragClasses();
        dragSourceId = null;
      });

      card.addEventListener("dragover", (e) => {
        if (!dragSourceId || dragSourceId === link.id) return;
        e.preventDefault();
        card.classList.add("drag-over");
        if (e.dataTransfer) e.dataTransfer.dropEffect = "move";
      });

      card.addEventListener("dragleave", () => {
        card.classList.remove("drag-over");
      });

      card.addEventListener("drop", (e) => {
        e.preventDefault();
        card.classList.remove("drag-over");
        if (!dragSourceId || dragSourceId === link.id) return;
        handleDrop(link.id);
      });

      return card;
    }

    function handleDrop(destId) {
      const sourceIndex = links.findIndex((l) => l.id === dragSourceId);
      const destIndex = links.findIndex((l) => l.id === destId);
      if (sourceIndex === -1 || destIndex === -1) return;

      const source = links[sourceIndex];
      const dest = links[destIndex];

      source.category = dest.category;

      links.splice(sourceIndex, 1);
      let insertIndex = destIndex;
      if (sourceIndex < destIndex) insertIndex--;
      links.splice(insertIndex, 0, source);

      saveLinksToStorage();
      touchLastModified();
      renderLinks();
    }

    function moveLinkWithinCategory(id, direction) {
      const index = links.findIndex((l) => l.id === id);
      if (index === -1) return;
      const cat = (links[index].category || "").trim();
      const step = direction === "up" ? -1 : 1;
      let j = index + step;

      while (j >= 0 && j < links.length) {
        const otherCat = (links[j].category || "").trim();
        if (otherCat === cat) {
          const tmp = links[index];
          links[index] = links[j];
          links[j] = tmp;
          break;
        }
        j += step;
      }
    }

    function handleMoveUp(id) {
      moveLinkWithinCategory(id, "up");
      saveLinksToStorage();
      touchLastModified();
      renderLinks();
    }

    function handleMoveDown(id) {
      moveLinkWithinCategory(id, "down");
      saveLinksToStorage();
      touchLastModified();
      renderLinks();
    }

    function handleDelete(id) {
      const link = links.find((l) => l.id === id);
      const title = link ? link.title : "";
      if (!confirm(`Weet je zeker dat je deze link wilt verwijderen?\n\n${title}`)) {
        return;
      }
      links = links.filter((l) => l.id !== id);
      saveLinksToStorage();
      touchLastModified();
      renderLinks();
    }

    function handleEdit(link) {
      const newTitle = prompt("Titel aanpassen:", link.title || "");
      if (newTitle === null) return;

      const newUrl = prompt("URL aanpassen:", link.url || "");
      if (newUrl === null) return;

      const newCategory = prompt(
        "Categorie aanpassen (bestaand of nieuw, leeg = Algemeen):",
        link.category || ""
      );
      if (newCategory === null) return;

      const t = newTitle.trim();
      const u = newUrl.trim();
      const c = newCategory.trim();

      if (t) link.title = t;
      if (u) link.url = normalizeUrl(u);
      link.category = c;

      saveLinksToStorage();
      touchLastModified();
      categoryPulseName = c || "Algemeen";
      renderLinks();
    }

    const linkForm = document.getElementById("linkForm");
    const titleInput = document.getElementById("titleInput");
    const urlInput = document.getElementById("urlInput");
    const categoryInput = document.getElementById("categoryInput");
    const fabAdd = document.getElementById("fabAdd");

    linkForm.addEventListener("submit", (ev) => {
      ev.preventDefault();

      const title = titleInput.value.trim();
      const url = urlInput.value.trim();
      let category = categoryInput.value.trim();

      if (!title || !url) return;

      if (!category) category = "Inbox";

      const normalizedUrl = normalizeUrl(url);

      const newLink = {
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
        title,
        url: normalizedUrl,
        category,
        createdAt: new Date().toISOString(),
      };

      links.push(newLink);
      saveLinksToStorage();
      touchLastModified();
      categoryPulseName = category || "Algemeen";
      renderLinks();

      linkForm.reset();
      titleInput.focus();
    });

    searchInput.addEventListener("input", () => {
      if (currentQuickFilter === "category") {
        currentQuickFilter = "all";
        currentCategoryFilterName = "";
      }
      renderLinks();
    });

    fabAdd.addEventListener("click", () => {
      const section = document.getElementById("newLinkSection");
      if (section && section.scrollIntoView) {
        section.scrollIntoView({ behavior: "smooth", block: "start" });
      }
      setTimeout(() => { titleInput.focus(); }, 250);
    });

    const quickFilterButtons = document.querySelectorAll(".chip[data-filter]");

    function setQuickFilter(filter) {
      currentQuickFilter = filter;
      if (filter === "all") {
        currentCategoryFilterName = "";
      } else if (filter === "inbox") {
        currentCategoryFilterName = "Inbox";
      }
      quickFilterButtons.forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.filter === filter);
      });
      renderLinks();
    }

    quickFilterButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const filter = btn.dataset.filter || "all";
        setQuickFilter(filter);
      });
    });

    // --- TASKLIST DATA ----------------------------------------------------
    const TASKS_STORAGE_KEY = "workTasksDataV1";

    /**
     * @typedef {{
     *  id: string,
     *  title: string,
     *  done: boolean,
     *  createdAt: string,
     *  dueDate: string | null,
     *  priority: "high"|"normal"|"low"|null,
     *  linkUrl: string | null
     * }} TaskItem
     */

    /** @type {TaskItem[]} */
    let tasks = [];

    const taskForm = document.getElementById("taskForm");
    const taskTitleInput = document.getElementById("taskTitleInput");
    const taskDueInput = document.getElementById("taskDueInput");
    const taskPriorityInput = document.getElementById("taskPriorityInput");
    const taskLinkInput = document.getElementById("taskLinkInput");
    const taskListOpen = document.getElementById("taskListOpen");
    const taskListDone = document.getElementById("taskListDone");
    const taskCountOpen = document.getElementById("taskCountOpen");
    const taskCountDone = document.getElementById("taskCountDone");

    function loadTasksFromStorage() {
      try {
        const raw = localStorage.getItem(TASKS_STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) {
          tasks = parsed.map((t) => ({
            id: t.id || String(Date.now() + Math.random()),
            title: String(t.title || "").trim() || "Zonder titel",
            done: !!t.done,
            createdAt: t.createdAt || new Date().toISOString(),
            dueDate: t.dueDate || null,
            priority: t.priority || null,
            linkUrl: t.linkUrl || null,
          }));
        }
      } catch (e) {
        console.error("Kon tasks niet laden:", e);
      }
    }

    function saveTasksToStorage() {
      try {
        localStorage.setItem(TASKS_STORAGE_KEY, JSON.stringify(tasks));
      } catch (e) {
        console.error("Kon tasks niet opslaan:", e);
      }
    }

    function renderTasks() {
      taskListOpen.innerHTML = "";
      taskListDone.innerHTML = "";

      const openTasks = tasks.filter((t) => !t.done);
      const doneTasks = tasks.filter((t) => t.done);

      if (!openTasks.length) {
        const span = document.createElement("div");
        span.className = "task-empty";
        span.textContent = "Geen open taken.";
        taskListOpen.appendChild(span);
      } else {
        openTasks
          .sort((a, b) => {
            const da = a.dueDate ? new Date(a.dueDate) : null;
            const db = b.dueDate ? new Date(b.dueDate) : null;
            if (da && db) return da - db;
            if (da) return -1;
            if (db) return 1;
            return 0;
          })
          .forEach((t) => taskListOpen.appendChild(renderTaskCard(t)));
      }

      if (!doneTasks.length) {
        const span = document.createElement("div");
        span.className = "task-empty";
        span.textContent = "Nog niets afgevinkt.";
        taskListDone.appendChild(span);
      } else {
        doneTasks
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
          .forEach((t) => taskListDone.appendChild(renderTaskCard(t)));
      }

      taskCountOpen.textContent = openTasks.length + " open";
      taskCountDone.textContent = doneTasks.length + " gedaan";
    }

    function renderTaskCard(task) {
      const card = document.createElement("div");
      card.className = "task-card";

      const main = document.createElement("div");
      main.className = "task-main";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.className = "task-check";
      checkbox.checked = task.done;
      checkbox.addEventListener("change", () => {
        toggleTaskDone(task.id);
      });

      const textBlock = document.createElement("div");

      const titleEl = document.createElement("div");
      titleEl.className = "task-title";
      if (task.done) titleEl.classList.add("done");
      titleEl.textContent = task.title;

      const metaRow = document.createElement("div");
      metaRow.className = "task-meta-row";

      if (task.dueDate) {
        const d = new Date(task.dueDate + "T00:00:00");
        if (!isNaN(d)) {
          const today = new Date();
          const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
          const diffDays = Math.round((d - todayStart) / 86400000);

          const pill = document.createElement("span");
          pill.className = "task-pill task-pill--due";

          if (isSameDay(d, today)) {
            pill.textContent = "üïí vandaag";
          } else if (diffDays === 1) {
            pill.textContent = "üïí morgen";
          } else if (diffDays < 0) {
            pill.textContent = "üïí te laat (" + formatShortDate(d) + ")";
            pill.classList.add("task-pill--due-overdue");
          } else {
            pill.textContent = "üïí " + formatShortDate(d);
          }
          metaRow.appendChild(pill);
        }
      }

      if (task.priority) {
        const prio = document.createElement("span");
        prio.className = "task-pill";
        if (task.priority === "high") {
          prio.classList.add("task-pill--prio-high");
          prio.textContent = "prio: hoog";
        } else if (task.priority === "normal") {
          prio.classList.add("task-pill--prio-normal");
          prio.textContent = "prio: normaal";
        } else if (task.priority === "low") {
          prio.classList.add("task-pill--prio-low");
          prio.textContent = "prio: laag";
        }
        metaRow.appendChild(prio);
      }

      if (task.linkUrl) {
        const linkPill = document.createElement("a");
        linkPill.href = task.linkUrl;
        linkPill.target = "_blank";
        linkPill.rel = "noopener noreferrer";
        linkPill.className = "task-pill task-pill--link";
        linkPill.textContent = "‚Üó link";
        metaRow.appendChild(linkPill);
      }

      textBlock.appendChild(titleEl);
      if (metaRow.childNodes.length > 0) textBlock.appendChild(metaRow);

      main.appendChild(checkbox);
      main.appendChild(textBlock);

      const actions = document.createElement("div");
      actions.className = "task-actions";

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "icon-button delete";
      delBtn.title = "Taak verwijderen";
      delBtn.textContent = "üóë";
      delBtn.addEventListener("click", () => deleteTask(task.id));

      actions.appendChild(delBtn);

      card.appendChild(main);
      card.appendChild(actions);

      return card;
    }

    function toggleTaskDone(id) {
      const t = tasks.find((task) => task.id === id);
      if (!t) return;
      t.done = !t.done;
      saveTasksToStorage();
      renderTasks();
    }

    function deleteTask(id) {
      const t = tasks.find((task) => task.id === id);
      const title = t ? t.title : "";
      if (!confirm(`Taak verwijderen?\n\n${title}`)) return;
      tasks = tasks.filter((task) => task.id !== id);
      saveTasksToStorage();
      renderTasks();
    }

    if (taskForm) {
      taskForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const title = taskTitleInput.value.trim();
        const due = taskDueInput.value.trim();
        const prio = taskPriorityInput.value || "";
        const linkRaw = taskLinkInput.value.trim();

        if (!title) return;

        const newTask = {
          id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
          title,
          done: false,
          createdAt: new Date().toISOString(),
          dueDate: due || null,
          priority: prio || null,
          linkUrl: linkRaw ? normalizeUrl(linkRaw) : null,
        };

        tasks.push(newTask);
        saveTasksToStorage();
        renderTasks();

        taskForm.reset();
        taskTitleInput.focus();
      });
    }

    // --- TERMINAL ---------------------------------------------------------
    const terminalInput = document.getElementById("terminalInput");
    const terminalOutput = document.getElementById("terminalOutput");

    const COMMANDS = [
      // link commands
      "help","search","stats","list","random","clear","cats",
      "open","openr","add","mv","recent","reset","cat",
      // task commands
      "t-help","t-list","t-add","t-done","t-del","t-clear-done"
    ];

    const terminalHistory = [];
    let terminalHistoryIndex = -1;

    function termPrint(lineHtml) {
      const div = document.createElement("div");
      div.className = "terminal-line";
      div.innerHTML = lineHtml;
      terminalOutput.appendChild(div);
      terminalOutput.scrollTop = terminalOutput.scrollHeight;
    }

    function termPrintError(msg) {
      termPrint('<span class="error">Error:</span> ' + escapeHtml(msg));
    }

    // Link commands via terminal
    function handleLinkCommand(name, argStr) {
      switch (name) {
        case "help":
          termPrint("Link-commando's:");
          termPrint("  help              - toon dit overzicht (links)");
          termPrint("  search <term>     - filter links op term");
          termPrint("  stats             - aantal links per categorie");
          termPrint("  list              - toon alle links (titel + categorie)");
          termPrint("  cats              - toon categorie√´n + aantallen");
          termPrint("  recent [n]        - toon laatste n links (default 5)");
          termPrint("  random            - kies willekeurige link");
          termPrint("  openr             - random link & open in tab");
          termPrint("  open <index>      - open link met index uit 'list'");
          termPrint("  add t|url|cat     - voeg link toe");
          termPrint("  mv <index> <cat>  - verplaats link naar categorie");
          termPrint("  cat <naam>        - filter op categorie");
          termPrint("  clear             - wis terminal output");
          termPrint("  reset YES         - wis ALLE links");
          termPrint("");
          termPrint("Taken-commando's: typ 't-help'.");
          break;

        case "search":
          if (!argStr) return termPrintError("Gebruik: search <term>");
          searchInput.value = argStr;
          currentQuickFilter = "all";
          currentCategoryFilterName = "";
          setQuickFilter("all");
          renderLinks();
          termPrint("Filter gezet op: " + escapeHtml(argStr));
          break;

        case "stats":
          if (!links.length) return termPrint("Geen links opgeslagen.");
          const counts = new Map();
          links.forEach((l) => {
            const c = (l.category || "Algemeen").trim() || "Algemeen";
            counts.set(c, (counts.get(c) || 0) + 1);
          });
          termPrint("Totaal links: " + links.length);
          counts.forEach((value, key) => {
            termPrint("  " + escapeHtml(key) + ": " + value);
          });
          break;

        case "cats": {
          if (!links.length) return termPrint("Geen links opgeslagen.");
          const catsMap = new Map();
          links.forEach((l) => {
            const c = (l.category || "Algemeen").trim() || "Algemeen";
            catsMap.set(c, (catsMap.get(c) || 0) + 1);
          });
          termPrint("Categorie√´n:");
          Array.from(catsMap.entries())
            .sort((a, b) => a[0].localeCompare(b[0], "nl", { sensitivity: "base" }))
            .forEach(([name, count]) => {
              termPrint("  " + escapeHtml(name) + ": " + count);
            });
          break;
        }

        case "list":
          if (!links.length) return termPrint("Geen links.");
          links.forEach((l, idx) => {
            const cat = (l.category || "Algemeen").trim() || "Algemeen";
            termPrint(
              "[" + idx + "] " +
              escapeHtml(l.title || "Zonder titel") +
              ' <span class="cmd">(' + escapeHtml(cat) + ")</span>"
            );
          });
          break;

        case "recent": {
          if (!links.length) return termPrint("Geen links.");
          let n = 5;
          if (argStr) {
            const parsed = parseInt(argStr, 10);
            if (!isNaN(parsed) && parsed > 0) n = parsed;
          }
          const sorted = [...links].sort((a, b) => {
            const da = a.createdAt ? new Date(a.createdAt) : new Date(0);
            const db = b.createdAt ? new Date(b.createdAt) : new Date(0);
            return db - da;
          });
          termPrint("Laatste " + n + " links:");
          sorted.slice(0, n).forEach((l) => {
            const cat = (l.category || "Algemeen").trim() || "Algemeen";
            termPrint(
              "- " +
              escapeHtml(l.title || "Zonder titel") +
              " (" + escapeHtml(cat) + ")"
            );
          });
          break;
        }

        case "random":
          if (!links.length) return termPrint("Geen links om uit te kiezen.");
          const rIndex = Math.floor(Math.random() * links.length);
          const item = links[rIndex];
          termPrint(
            "Random [" + rIndex + "]: " +
            escapeHtml(item.title || "Zonder titel") +
            " ‚Üí " +
            '<a href="' + escapeHtml(item.url) +
            '" target="_blank" rel="noopener noreferrer">' +
            escapeHtml(item.url) + "</a>"
          );
          break;

        case "openr":
          if (!links.length) return termPrint("Geen links om uit te kiezen.");
          const rIndex2 = Math.floor(Math.random() * links.length);
          const item2 = links[rIndex2];
          termPrint(
            "Random open [" + rIndex2 + "]: " +
            escapeHtml(item2.title || "Zonder titel")
          );
          window.open(item2.url, "_blank", "noopener");
          break;

        case "open": {
          if (!argStr) return termPrintError("Gebruik: open <index>");
          const idx = parseInt(argStr, 10);
          if (isNaN(idx) || idx < 0 || idx >= links.length) {
            return termPrintError("Ongeldige index.");
          }
          const l = links[idx];
          termPrint("Openen [" + idx + "]: " + escapeHtml(l.title || "Zonder titel"));
          window.open(l.url, "_blank", "noopener");
          break;
        }

        case "add": {
          if (!argStr) return termPrintError("Gebruik: add titel|url|categorie");
          const parts = argStr.split("|");
          if (parts.length < 2) {
            return termPrintError("Gebruik: add titel|url|categorie (categorie optioneel)");
          }
          const title = parts[0].trim();
          const url = parts[1].trim();
          let cat = (parts[2] || "").trim();
          if (!title || !url) {
            return termPrintError("Titel en URL zijn verplicht.");
          }
          if (!cat) cat = "Inbox";

          const newLink = {
            id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
            title,
            url: normalizeUrl(url),
            category: cat,
            createdAt: new Date().toISOString(),
          };
          links.push(newLink);
          saveLinksToStorage();
          touchLastModified();
          categoryPulseName = cat || "Algemeen";
          renderLinks();
          termPrint("Link toegevoegd: " + escapeHtml(title));
          break;
        }

        case "mv": {
          if (!argStr) {
            termPrintError("Gebruik: mv <index> <categorie>");
            break;
          }
          const [idxStr, ...catParts] = argStr.split(" ");
          const idx = parseInt(idxStr, 10);
          const cat = catParts.join(" ").trim();
          if (
            isNaN(idx) ||
            idx < 0 ||
            idx >= links.length ||
            !cat
          ) {
            termPrintError("Gebruik: mv <index> <categorie>");
            break;
          }
          links[idx].category = cat;
          saveLinksToStorage();
          touchLastModified();
          categoryPulseName = cat || "Algemeen";
          renderLinks();
          termPrint(
            "Link [" + idx + "] verplaatst naar categorie: " +
            escapeHtml(cat)
          );
          break;
        }

        case "cat":
          if (!argStr) return termPrintError("Gebruik: cat <categorie-naam>");
          currentQuickFilter = "category";
          currentCategoryFilterName = argStr;
          quickFilterButtons.forEach((btn) => btn.classList.remove("active"));
          renderLinks();
          termPrint("Gefilterd op categorie: " + escapeHtml(argStr));
          break;

        case "clear":
          terminalOutput.innerHTML = "";
          break;

        case "reset":
          if (argStr !== "YES") {
            termPrint("Bevestig met: reset YES");
            break;
          }
          links = [];
          saveLinksToStorage();
          touchLastModified();
          renderLinks();
          termPrint("Alle links zijn verwijderd.");
          break;

        default:
          termPrintError("Onbekend link-commando. Typ 'help'.");
      }
    }

    // Task commands via terminal
    function handleTaskCommand(name, argStr) {
      switch (name) {
        case "t-help":
          termPrint("Tasklist-commando's:");
          termPrint("  t-help                 - toon dit overzicht");
          termPrint("  t-list [open|done|all] - toon taken (default: open)");
          termPrint("  t-add t|[due]|[prio]|[url]");
          termPrint("       due  = YYYY-MM-DD (optioneel)");
          termPrint("       prio = high | normal | low (optioneel)");
          termPrint("       url  = gerelateerde link (optioneel)");
          termPrint("  t-done <index>         - markeer open taak als gedaan");
          termPrint("  t-del <index>          - verwijder open taak");
          termPrint("  t-clear-done           - verwijder alle afgeronde taken");
          break;

        case "t-list": {
          const mode = (argStr || "open").toLowerCase();
          const openTasks = tasks.filter((t) => !t.done);
          const doneTasks = tasks.filter((t) => t.done);

          if (mode === "open") {
            if (!openTasks.length) return termPrint("Geen open taken.");
            termPrint("Open taken:");
            openTasks.forEach((t, idx) => {
              const dueStr = t.dueDate ? (" [" + t.dueDate + "]") : "";
              const prioStr = t.priority ? (" (" + t.priority + ")") : "";
              termPrint(
                "[" + idx + "] " +
                escapeHtml(t.title) +
                dueStr + prioStr
              );
            });
            termPrint("Index hierboven gebruik je met t-done en t-del.");
          } else if (mode === "done") {
            if (!doneTasks.length) return termPrint("Geen afgeronde taken.");
            termPrint("Afgeronde taken:");
            doneTasks.forEach((t, idx) => {
              const dueStr = t.dueDate ? (" [" + t.dueDate + "]") : "";
              const prioStr = t.priority ? (" (" + t.priority + ")") : "";
              termPrint(
                "[" + idx + "] " +
                escapeHtml(t.title) +
                dueStr + prioStr
              );
            });
          } else if (mode === "all") {
            if (!tasks.length) return termPrint("Geen taken.");
            termPrint("Open taken:");
            openTasks.forEach((t, idx) => {
              const dueStr = t.dueDate ? (" [" + t.dueDate + "]") : "";
              const prioStr = t.priority ? (" (" + t.priority + ")") : "";
              termPrint(
                "[O" + idx + "] " +
                escapeHtml(t.title) +
                dueStr + prioStr
              );
            });
            termPrint("");
            termPrint("Afgeronde taken:");
            doneTasks.forEach((t, idx) => {
              const dueStr = t.dueDate ? (" [" + t.dueDate + "]") : "";
              const prioStr = t.priority ? (" (" + t.priority + ")") : "";
              termPrint(
                "[D" + idx + "] " +
                escapeHtml(t.title) +
                dueStr + prioStr
              );
            });
          } else {
            termPrintError("Gebruik: t-list [open|done|all]");
          }
          break;
        }

        case "t-add": {
          if (!argStr) {
            termPrintError("Gebruik: t-add titel|[due]|[prio]|[url]");
            break;
          }
          const parts = argStr.split("|");
          const title = (parts[0] || "").trim();
          const dueRaw = (parts[1] || "").trim();
          const prioRaw = (parts[2] || "").trim().toLowerCase();
          const urlRaw = (parts[3] || "").trim();

          if (!title) {
            termPrintError("Titel is verplicht.");
            break;
          }

          let due = null;
          if (dueRaw && /^\d{4}-\d{2}-\d{2}$/.test(dueRaw)) {
            due = dueRaw;
          } else if (dueRaw) {
            termPrint("Waarschuwing: due date niet herkend, overslagen.");
          }

          let prio = null;
          if (prioRaw === "high" || prioRaw === "normal" || prioRaw === "low") {
            prio = prioRaw;
          } else if (prioRaw) {
            termPrint("Waarschuwing: onbekende prioriteit, overslagen.");
          }

          const newTask = {
            id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
            title,
            done: false,
            createdAt: new Date().toISOString(),
            dueDate: due,
            priority: prio,
            linkUrl: urlRaw ? normalizeUrl(urlRaw) : null,
          };

          tasks.push(newTask);
          saveTasksToStorage();
          renderTasks();
          termPrint("Taak toegevoegd: " + escapeHtml(title));
          break;
        }

        case "t-done": {
          if (!argStr) {
            termPrintError("Gebruik: t-done <index>");
            break;
          }
          const idx = parseInt(argStr, 10);
          const openTasks = tasks.filter((t) => !t.done);
          if (isNaN(idx) || idx < 0 || idx >= openTasks.length) {
            termPrintError("Ongeldige index (gebruik index uit t-list).");
            break;
          }
          const target = openTasks[idx];
          const realIndex = tasks.findIndex((t) => t.id === target.id);
          if (realIndex === -1) break;
          tasks[realIndex].done = true;
          saveTasksToStorage();
          renderTasks();
          termPrint("Taak afgevinkt: " + escapeHtml(target.title));
          break;
        }

        case "t-del": {
          if (!argStr) {
            termPrintError("Gebruik: t-del <index>");
            break;
          }
          const idx = parseInt(argStr, 10);
          const openTasks = tasks.filter((t) => !t.done);
          if (isNaN(idx) || idx < 0 || idx >= openTasks.length) {
            termPrintError("Ongeldige index (alleen open taken).");
            break;
          }
          const target = openTasks[idx];
          if (!confirm(`Taak verwijderen?\n\n${target.title}`)) break;
          tasks = tasks.filter((t) => t.id !== target.id);
          saveTasksToStorage();
          renderTasks();
          termPrint("Taak verwijderd.");
          break;
        }

        case "t-clear-done": {
          const hadDone = tasks.some((t) => t.done);
          tasks = tasks.filter((t) => !t.done);
          saveTasksToStorage();
          renderTasks();
          termPrint(hadDone ? "Alle afgeronde taken verwijderd." : "Geen afgeronde taken.");
          break;
        }

        default:
          termPrintError("Onbekend task-commando. Typ 't-help'.");
      }
    }

    function handleTerminalCommand(cmdRaw) {
      const cmd = cmdRaw.trim();
      if (!cmd) return;

      termPrint('&gt; <span class="cmd">' + escapeHtml(cmd) + "</span>");

      const [first, ...rest] = cmd.split(" ");
      const argStr = rest.join(" ").trim();
      const name = first.toLowerCase();

      if (name.startsWith("t-")) {
        handleTaskCommand(name, argStr);
      } else {
        handleLinkCommand(name, argStr);
      }
    }

    if (terminalInput) {
      terminalInput.addEventListener("keydown", (e) => {
        if (e.key === "ArrowUp") {
          if (!terminalHistory.length) return;
          if (terminalHistoryIndex === -1) {
            terminalHistoryIndex = terminalHistory.length - 1;
          } else if (terminalHistoryIndex > 0) {
            terminalHistoryIndex--;
          }
          terminalInput.value = terminalHistory[terminalHistoryIndex] || "";
          e.preventDefault();
          return;
        }

        if (e.key === "ArrowDown") {
          if (!terminalHistory.length) return;
          if (terminalHistoryIndex === -1) return;
          if (terminalHistoryIndex < terminalHistory.length - 1) {
            terminalHistoryIndex++;
            terminalInput.value = terminalHistory[terminalHistoryIndex] || "";
          } else {
            terminalHistoryIndex = -1;
            terminalInput.value = "";
          }
          e.preventDefault();
          return;
        }

        if (e.key === "Tab") {
          e.preventDefault();
          const value = terminalInput.value.trim();
          if (!value) return;
          const parts = value.split(/\s+/);
          if (parts.length === 1) {
            const partial = parts[0].toLowerCase();
            const match = COMMANDS.find((c) => c.startsWith(partial));
            if (match) terminalInput.value = match + " ";
          }
          return;
        }

        if (e.key === "Enter") {
          e.preventDefault();
          const value = terminalInput.value;
          if (value.trim()) {
            terminalHistory.push(value);
            terminalHistoryIndex = -1;
          }
          terminalInput.value = "";
          handleTerminalCommand(value);
        }
      });
    }

    function printMotd() {
      const messages = [
        "stay hydrated. je links zijn dat niet.",
        "small steps ‚Üí big systems. √©√©n link tegelijk.",
        "pro tip: druk '/' om direct te zoeken.",
        "pro tip: typ 'help' voor links, 't-help' voor taken.",
      ];
      const msg = messages[Math.floor(Math.random() * messages.length)];
      termPrint("MOTD: " + msg);
      if (links.length) {
        termPrint("Je hebt momenteel " + links.length + " links opgeslagen.");
      }
      if (tasks.length) {
        termPrint("Je hebt momenteel " + tasks.length + " taken in TASKLIST.APP.");
      }
    }

    // --- Keyboard shortcuts -----------------------------------------------
    function isTypingInInput(el) {
      if (!el) return false;
      const tag = el.tagName;
      return tag === "INPUT" || tag === "TEXTAREA" || el.isContentEditable;
    }

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        if (document.activeElement === searchInput) {
          searchInput.value = "";
          renderLinks();
        }
        if (document.activeElement === terminalInput) {
          terminalInput.value = "";
        }
        return;
      }

      if (isTypingInInput(e.target)) return;

      if (e.key === "/") {
        e.preventDefault();
        searchInput.focus();
        searchInput.select();
      } else if (e.key === "n" || e.key === "N") {
        e.preventDefault();
        titleInput.focus();
        titleInput.select();
      } else if (e.key === "t" || e.key === "T") {
        e.preventDefault();
        terminalInput.focus();
      }
    });

    // --- Export / import (links) -----------------------------------------
    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");
    const importFile = document.getElementById("importFile");

    exportBtn.addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(links, null, 2)], {
        type: "application/json",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const today = new Date().toISOString().slice(0, 10);
      a.href = url;
      a.download = `work-links-export-${today}.json`;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    });

    importBtn.addEventListener("click", () => {
      importFile.value = "";
      importFile.click();
    });

    importFile.addEventListener("change", () => {
      const file = importFile.files && importFile.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (evt) => {
        try {
          const text = String(evt.target.result);
          const parsed = JSON.parse(text);
          if (!Array.isArray(parsed)) {
            alert("Bestand bevat geen geldige lijst met links.");
            return;
          }
          const cleaned = parsed
            .filter((item) => item && typeof item === "object")
            .map((item) => ({
              id: item.id || String(Date.now() + Math.random()),
              title: String(item.title || "").trim() || "Zonder titel",
              url: String(item.url || "").trim(),
              category: String(item.category || "").trim(),
              createdAt: item.createdAt || new Date().toISOString(),
            }))
            .filter((item) => item.url);

          links = cleaned;
          saveLinksToStorage();
          touchLastModified();
          categoryPulseName = null;
          renderLinks();
        } catch (err) {
          console.error(err);
          alert("Kon dit JSON-bestand niet lezen.");
        }
      };
      reader.readAsText(file);
    });

    // --- Init -------------------------------------------------------------
    loadLinksFromStorage();
    loadLastModified();
    renderLinks();

    loadTasksFromStorage();
    renderTasks();

    printMotd();
  </script>
</body>
</html>
